"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = require("path");
const github_1 = require("@actions/github");
const core_1 = require("@actions/core");
const { GITHUB_TOKEN, GITHUB_SHA, GITHUB_WORKSPACE } = process.env;
const ACTION_NAME = 'ESLint';
const EXTENSIONS = new Set(['.ts', '.js']);
async function lint(files) {
    const { CLIEngine } = await Promise.resolve().then(() => require(path_1.join(process.cwd(), 'node_modules/eslint')));
    const cli = new CLIEngine({
        extensions: [...EXTENSIONS],
        ignorePath: '.gitignore'
    });
    const report = cli.executeOnFiles(files || ['src']);
    const { results, errorCount, warningCount } = report;
    const levels = ['notice', 'warning', 'failure'];
    const annotations = [];
    for (const res of results) {
        const { filePath, messages } = res;
        const path = filePath.substring(GITHUB_WORKSPACE.length + 1);
        for (const msg of messages) {
            const { line, endLine, column, endColumn, severity, ruleId, message } = msg;
            const annotationLevel = levels[severity];
            annotations.push({
                path,
                start_line: line,
                end_line: endLine || line,
                start_column: column,
                end_column: endColumn || column,
                annotation_level: annotationLevel,
                title: ruleId || ACTION_NAME,
                message
            });
        }
    }
    return {
        conclusion: errorCount > 0 ? 'failure' : 'success',
        output: {
            title: ACTION_NAME,
            summary: `${errorCount} error(s), ${warningCount} warning(s) found`,
            annotations
        }
    };
}
async function run() {
    const octokit = new github_1.GitHub(GITHUB_TOKEN);
    let currentSha;
    let info;
    let lintFiles;
    if (github_1.context.issue && github_1.context.issue.number) {
        info = await octokit.graphql(`query($owner: String!, $name: String!, $prNumber: Int!) {
			repository(owner: $owner, name: $name) {
				pullRequest(number: $prNumber) {
					files(first: 100) {
						nodes {
							path
						}
					}
					commits(last: 1) {
						nodes {
							commit {
								oid
							}
						}
					}
				}
			}
		}`, {
            owner: github_1.context.repo.owner,
            name: github_1.context.repo.repo,
            prNumber: github_1.context.issue.number
        });
        currentSha = info.repository.pullRequest.commits.nodes[0].commit.oid;
        const files = info.repository.pullRequest.files.nodes;
        lintFiles = files.filter((file) => EXTENSIONS.has(path_1.extname(file.path))).map((f) => f.path);
    }
    else {
        info = await octokit.repos.getCommit({ owner: github_1.context.repo.owner, repo: github_1.context.repo.repo, ref: GITHUB_SHA });
        currentSha = GITHUB_SHA;
        const files = info.data.files;
        lintFiles = files.filter(file => EXTENSIONS.has(path_1.extname(file.filename))).map(f => f.filename);
    }
    core_1.debug(`Commit: ${currentSha}`);
    let id;
    const jobName = core_1.getInput('job-name');
    if (jobName) {
        const checks = await octokit.checks.listForRef({
            ...github_1.context.repo,
            status: 'in_progress',
            ref: currentSha
        });
        const check = checks.data.check_runs.find(({ name }) => name.toLowerCase() === jobName.toLowerCase());
        if (check)
            id = check.id;
    }
    if (!id) {
        id = (await octokit.checks.create({
            ...github_1.context.repo,
            name: ACTION_NAME,
            head_sha: currentSha,
            status: 'in_progress',
            started_at: new Date().toISOString()
        })).data.id;
    }
    try {
        const lintAll = core_1.getInput('lint-all');
        const { conclusion, output } = await lint(lintAll ? null : lintFiles);
        await octokit.checks.update({
            ...github_1.context.repo,
            check_run_id: id,
            completed_at: new Date().toISOString(),
            conclusion,
            output
        });
        core_1.debug(output.summary);
        if (conclusion === 'failure')
            core_1.setFailed(output.summary);
    }
    catch (error) {
        await octokit.checks.update({
            ...github_1.context.repo,
            check_run_id: id,
            conclusion: 'failure',
            completed_at: new Date().toISOString()
        });
        core_1.setFailed(error.message);
    }
}
run();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIvIiwic291cmNlcyI6WyJtYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQXFDO0FBRXJDLDRDQUFrRDtBQUNsRCx3Q0FBMkQ7QUFFM0QsTUFBTSxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO0FBRW5FLE1BQU0sV0FBVyxHQUFHLFFBQVEsQ0FBQztBQUM3QixNQUFNLFVBQVUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBRTNDLEtBQUssVUFBVSxJQUFJLENBQUMsS0FBc0I7SUFDekMsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLDJDQUFhLFdBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUscUJBQXFCLENBQUMsRUFBNEIsQ0FBQztJQUMxRyxNQUFNLEdBQUcsR0FBRyxJQUFJLFNBQVMsQ0FBQztRQUN6QixVQUFVLEVBQUUsQ0FBQyxHQUFHLFVBQVUsQ0FBQztRQUMzQixVQUFVLEVBQUUsWUFBWTtLQUN4QixDQUFDLENBQUM7SUFDSCxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsY0FBYyxDQUFDLEtBQUssSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDcEQsTUFBTSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLEdBQUcsTUFBTSxDQUFDO0lBQ3JELE1BQU0sTUFBTSxHQUE4RCxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDM0csTUFBTSxXQUFXLEdBQTBDLEVBQUUsQ0FBQztJQUM5RCxLQUFLLE1BQU0sR0FBRyxJQUFJLE9BQU8sRUFBRTtRQUMxQixNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxHQUFHLEdBQUcsQ0FBQztRQUNuQyxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFD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QUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3RFLE1BQU0sT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7WUFDM0IsR0FBRyxnQkFBTyxDQUFDLElBQUk7WUFDZixZQUFZLEVBQUUsRUFBRTtZQUNoQixZQUFZLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7WUFDdEMsVUFBVTtZQUNWLE1BQU07U0FDTixDQUFDLENBQUM7UUFDSCxZQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3RCLElBQUksVUFBVSxLQUFLLFNBQVM7WUFBRSxnQkFBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztLQUN4RDtJQUFDLE9BQU8sS0FBSyxFQUFFO1FBQ2YsTUFBTSxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztZQUMzQixHQUFHLGdCQUFPLENBQUMsSUFBSTtZQUNmLFlBQVksRUFBRSxFQUFFO1lBQ2hCLFVBQVUsRUFBRSxTQUFTO1lBQ3JCLFlBQVksRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUN0QyxDQUFDLENBQUM7UUFDSCxnQkFBUyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztLQUN6QjtBQUNGLENBQUM7QUFFRCxHQUFHLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGpvaW4sIGV4dG5hbWUgfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IENoZWNrc1VwZGF0ZVBhcmFtc091dHB1dEFubm90YXRpb25zLCBDaGVja3NDcmVhdGVQYXJhbXMgfSBmcm9tICdAb2N0b2tpdC9yZXN0JztcbmltcG9ydCB7IEdpdEh1YiwgY29udGV4dCB9IGZyb20gJ0BhY3Rpb25zL2dpdGh1Yic7XG5pbXBvcnQgeyBnZXRJbnB1dCwgc2V0RmFpbGVkLCBkZWJ1ZyB9IGZyb20gJ0BhY3Rpb25zL2NvcmUnO1xuXG5jb25zdCB7IEdJVEhVQl9UT0tFTiwgR0lUSFVCX1NIQSwgR0lUSFVCX1dPUktTUEFDRSB9ID0gcHJvY2Vzcy5lbnY7XG5cbmNvbnN0IEFDVElPTl9OQU1FID0gJ0VTTGludCc7XG5jb25zdCBFWFRFTlNJT05TID0gbmV3IFNldChbJy50cycsICcuanMnXSk7XG5cbmFzeW5jIGZ1bmN0aW9uIGxpbnQoZmlsZXM6IHN0cmluZ1tdIHwgbnVsbCkge1xuXHRjb25zdCB7IENMSUVuZ2luZSB9ID0gYXdhaXQgaW1wb3J0KGpvaW4ocHJvY2Vzcy5jd2QoKSwgJ25vZGVfbW9kdWxlcy9lc2xpbnQnKSkgYXMgdHlwZW9mIGltcG9ydCgnZXNsaW50Jyk7XG5cdGNvbnN0IGNsaSA9IG5ldyBDTElFbmdpbmUoe1xuXHRcdGV4dGVuc2lvbnM6IFsuLi5FWFRFTlNJT05TXSxcblx0XHRpZ25vcmVQYXRoOiAnLmdpdGlnbm9yZSdcblx0fSk7XG5cdGNvbnN0IHJlcG9ydCA9IGNsaS5leGVjdXRlT25GaWxlcyhmaWxlcyB8fCBbJ3NyYyddKTtcblx0Y29uc3QgeyByZXN1bHRzLCBlcnJvckNvdW50LCB3YXJuaW5nQ291bnQgfSA9IHJlcG9ydDtcblx0Y29uc3QgbGV2ZWxzOiBDaGVja3NVcGRhdGVQYXJhbXNPdXRwdXRBbm5vdGF0aW9uc1snYW5ub3RhdGlvbl9sZXZlbCddW10gPSBbJ25vdGljZScsICd3YXJuaW5nJywgJ2ZhaWx1cmUnXTtcblx0Y29uc3QgYW5ub3RhdGlvbnM6IENoZWNrc1VwZGF0ZVBhcmFtc091dHB1dEFubm90YXRpb25zW10gPSBbXTtcblx0Zm9yIChjb25zdCByZXMgb2YgcmVzdWx0cykge1xuXHRcdGNvbnN0IHsgZmlsZVBhdGgsIG1lc3NhZ2VzIH0gPSByZXM7XG5cdFx0Y29uc3QgcGF0aCA9IGZpbGVQYXRoLnN1YnN0cmluZyhHSVRIVUJfV09SS1NQQUNFIS5sZW5ndGggKyAxKTtcblx0XHRmb3IgKGNvbnN0IG1zZyBvZiBtZXNzYWdlcykge1xuXHRcdFx0Y29uc3QgeyBsaW5lLCBlbmRMaW5lLCBjb2x1bW4sIGVuZENvbHVtbiwgc2V2ZXJpdHksIHJ1bGVJZCwgbWVzc2FnZSB9ID0gbXNnO1xuXHRcdFx0Y29uc3QgYW5ub3RhdGlvbkxldmVsID0gbGV2ZWxzW3NldmVyaXR5XTtcblx0XHRcdGFubm90YXRpb25zLnB1c2goe1xuXHRcdFx0XHRwYXRoLFxuXHRcdFx0XHRzdGFydF9saW5lOiBsaW5lLFxuXHRcdFx0XHRlbmRfbGluZTogZW5kTGluZSB8fCBsaW5lLFxuXHRcdFx0XHRzdGFydF9jb2x1bW46IGNvbHVtbixcblx0XHRcdFx0ZW5kX2NvbHVtbjogZW5kQ29sdW1uIHx8IGNvbHVtbixcblx0XHRcdFx0YW5ub3RhdGlvbl9sZXZlbDogYW5ub3RhdGlvbkxldmVsLFxuXHRcdFx0XHR0aXRsZTogcnVsZUlkIHx8IEFDVElPTl9OQU1FLFxuXHRcdFx0XHRtZXNzYWdlXG5cdFx0XHR9KTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4ge1xuXHRcdGNvbmNsdXNpb246IGVycm9yQ291bnQgPiAwID8gJ2ZhaWx1cmUnIDogJ3N1Y2Nlc3MnIGFzIENoZWNrc0NyZWF0ZVBhcmFtc1snY29uY2x1c2lvbiddLFxuXHRcdG91dHB1dDoge1xuXHRcdFx0dGl0bGU6IEFDVElPTl9OQU1FLFxuXHRcdFx0c3VtbWFyeTogYCR7ZXJyb3JDb3VudH0gZXJyb3IocyksICR7d2FybmluZ0NvdW50fSB3YXJuaW5nKHMpIGZvdW5kYCxcblx0XHRcdGFubm90YXRpb25zXG5cdFx0fVxuXHR9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBydW4oKSB7XG5cdGNvbnN0IG9jdG9raXQgPSBuZXcgR2l0SHViKEdJVEhVQl9UT0tFTiEpO1xuXG5cdGxldCBjdXJyZW50U2hhOiBzdHJpbmc7XG5cdGxldCBpbmZvO1xuXHRsZXQgbGludEZpbGVzO1xuXHRpZiAoY29udGV4dC5pc3N1ZSAmJiBjb250ZXh0Lmlzc3VlLm51bWJlcikge1xuXHRcdGluZm8gPSBhd2FpdCBvY3Rva2l0LmdyYXBocWwoYHF1ZXJ5KCRvd25lcjogU3RyaW5nISwgJG5hbWU6IFN0cmluZyEsICRwck51bWJlcjogSW50ISkge1xuXHRcdFx0cmVwb3NpdG9yeShvd25lcjogJG93bmVyLCBuYW1lOiAkbmFtZSkge1xuXHRcdFx0XHRwdWxsUmVxdWVzdChudW1iZXI6ICRwck51bWJlcikge1xuXHRcdFx0XHRcdGZpbGVzKGZpcnN0OiAxMDApIHtcblx0XHRcdFx0XHRcdG5vZGVzIHtcblx0XHRcdFx0XHRcdFx0cGF0aFxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRjb21taXRzKGxhc3Q6IDEpIHtcblx0XHRcdFx0XHRcdG5vZGVzIHtcblx0XHRcdFx0XHRcdFx0Y29tbWl0IHtcblx0XHRcdFx0XHRcdFx0XHRvaWRcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH1gLFxuXHRcdHtcblx0XHRcdG93bmVyOiBjb250ZXh0LnJlcG8ub3duZXIsXG5cdFx0XHRuYW1lOiBjb250ZXh0LnJlcG8ucmVwbyxcblx0XHRcdHByTnVtYmVyOiBjb250ZXh0Lmlzc3VlLm51bWJlclxuXHRcdH0pO1xuXHRcdGN1cnJlbnRTaGEgPSBpbmZvLnJlcG9zaXRvcnkucHVsbFJlcXVlc3QuY29tbWl0cy5ub2Rlc1swXS5jb21taXQub2lkO1xuXHRcdGNvbnN0IGZpbGVzID0gaW5mby5yZXBvc2l0b3J5LnB1bGxSZXF1ZXN0LmZpbGVzLm5vZGVzO1xuXHRcdGxpbnRGaWxlcyA9IGZpbGVzLmZpbHRlcigoZmlsZTogeyBwYXRoOiBzdHJpbmcgfSkgPT4gRVhURU5TSU9OUy5oYXMoZXh0bmFtZShmaWxlLnBhdGgpKSkubWFwKChmOiB7IHBhdGg6IHN0cmluZyB9KSA9PiBmLnBhdGgpO1xuXHR9IGVsc2Uge1xuXHRcdGluZm8gPSBhd2FpdCBvY3Rva2l0LnJlcG9zLmdldENvbW1pdCh7IG93bmVyOiBjb250ZXh0LnJlcG8ub3duZXIsIHJlcG86IGNvbnRleHQucmVwby5yZXBvLCByZWY6IEdJVEhVQl9TSEEhIH0pO1xuXHRcdGN1cnJlbnRTaGEgPSBHSVRIVUJfU0hBITtcblx0XHRjb25zdCBmaWxlcyA9IGluZm8uZGF0YS5maWxlcztcblx0XHRsaW50RmlsZXMgPSBmaWxlcy5maWx0ZXIoZmlsZSA9PiBFWFRFTlNJT05TLmhhcyhleHRuYW1lKGZpbGUuZmlsZW5hbWUpKSkubWFwKGYgPT4gZi5maWxlbmFtZSk7XG5cdH1cblx0ZGVidWcoYENvbW1pdDogJHtjdXJyZW50U2hhfWApO1xuXG5cdGxldCBpZDogbnVtYmVyIHwgdW5kZWZpbmVkO1xuXHRjb25zdCBqb2JOYW1lID0gZ2V0SW5wdXQoJ2pvYi1uYW1lJyk7XG5cdGlmIChqb2JOYW1lKSB7XG5cdFx0Y29uc3QgY2hlY2tzID0gYXdhaXQgb2N0b2tpdC5jaGVja3MubGlzdEZvclJlZih7XG5cdFx0XHQuLi5jb250ZXh0LnJlcG8sXG5cdFx0XHRzdGF0dXM6ICdpbl9wcm9ncmVzcycsXG5cdFx0XHRyZWY6IGN1cnJlbnRTaGFcblx0XHR9KTtcblx0XHRjb25zdCBjaGVjayA9IGNoZWNrcy5kYXRhLmNoZWNrX3J1bnMuZmluZCgoeyBuYW1lIH0pID0+IG5hbWUudG9Mb3dlckNhc2UoKSA9PT0gam9iTmFtZS50b0xvd2VyQ2FzZSgpKTtcblx0XHRpZiAoY2hlY2spIGlkID0gY2hlY2suaWQ7XG5cdH1cblx0aWYgKCFpZCkge1xuXHRcdGlkID0gKGF3YWl0IG9jdG9raXQuY2hlY2tzLmNyZWF0ZSh7XG5cdFx0XHQuLi5jb250ZXh0LnJlcG8sXG5cdFx0XHRuYW1lOiBBQ1RJT05fTkFNRSxcblx0XHRcdGhlYWRfc2hhOiBjdXJyZW50U2hhLFxuXHRcdFx0c3RhdHVzOiAnaW5fcHJvZ3Jlc3MnLFxuXHRcdFx0c3RhcnRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG5cdFx0fSkpLmRhdGEuaWQ7XG5cdH1cblxuXHR0cnkge1xuXHRcdGNvbnN0IGxpbnRBbGwgPSBnZXRJbnB1dCgnbGludC1hbGwnKTtcblx0XHRjb25zdCB7IGNvbmNsdXNpb24sIG91dHB1dCB9ID0gYXdhaXQgbGludChsaW50QWxsID8gbnVsbCA6IGxpbnRGaWxlcyk7XG5cdFx0YXdhaXQgb2N0b2tpdC5jaGVja3MudXBkYXRlKHtcblx0XHRcdC4uLmNvbnRleHQucmVwbyxcblx0XHRcdGNoZWNrX3J1bl9pZDogaWQsXG5cdFx0XHRjb21wbGV0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcblx0XHRcdGNvbmNsdXNpb24sXG5cdFx0XHRvdXRwdXRcblx0XHR9KTtcblx0XHRkZWJ1ZyhvdXRwdXQuc3VtbWFyeSk7XG5cdFx0aWYgKGNvbmNsdXNpb24gPT09ICdmYWlsdXJlJykgc2V0RmFpbGVkKG91dHB1dC5zdW1tYXJ5KTtcblx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRhd2FpdCBvY3Rva2l0LmNoZWNrcy51cGRhdGUoe1xuXHRcdFx0Li4uY29udGV4dC5yZXBvLFxuXHRcdFx0Y2hlY2tfcnVuX2lkOiBpZCxcblx0XHRcdGNvbmNsdXNpb246ICdmYWlsdXJlJyxcblx0XHRcdGNvbXBsZXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG5cdFx0fSk7XG5cdFx0c2V0RmFpbGVkKGVycm9yLm1lc3NhZ2UpO1xuXHR9XG59XG5cbnJ1bigpO1xuIl19