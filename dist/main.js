"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = require("path");
const github_1 = require("@actions/github");
const core_1 = require("@actions/core");
const { GITHUB_TOKEN, GITHUB_SHA, GITHUB_WORKSPACE } = process.env;
const ACTION_NAME = 'ESLint';
const EXTENSIONS = new Set(['.ts', '.js']);
async function lint(files) {
    const { CLIEngine } = await Promise.resolve().then(() => require(path_1.join(process.cwd(), 'node_modules/eslint')));
    const cli = new CLIEngine({
        extensions: [...EXTENSIONS],
        ignorePath: '.gitignore'
    });
    const report = cli.executeOnFiles(files || ['src']);
    const { results, errorCount, warningCount } = report;
    const levels = ['notice', 'warning', 'failure'];
    const annotations = [];
    const consoleOutput = [];
    for (const res of results) {
        const { filePath, messages } = res;
        const path = filePath.substring(GITHUB_WORKSPACE.length + 1);
        for (const msg of messages) {
            const { line, endLine, column, endColumn, severity, ruleId, message } = msg;
            const annotationLevel = levels[severity];
            annotations.push({
                path,
                start_line: line,
                end_line: endLine || line,
                start_column: column,
                end_column: endColumn || column,
                annotation_level: annotationLevel,
                title: ruleId || ACTION_NAME,
                message: `${message}${ruleId ? `\n\nhttps://eslint.org/docs/rules/${ruleId}` : ''}`
            });
            consoleOutput.push(path);
            consoleOutput.push(`##[${severity}]  ${line}:${column}  ${severity}  ${message}  ${ruleId}\n\n`);
        }
    }
    console.log(consoleOutput.join(''));
    return {
        conclusion: errorCount > 0 ? 'failure' : 'success',
        output: {
            title: ACTION_NAME,
            summary: `${errorCount} error(s), ${warningCount} warning(s) found`,
            annotations
        }
    };
}
async function run() {
    const octokit = new github_1.GitHub(GITHUB_TOKEN);
    let currentSha;
    let info;
    let lintFiles;
    if (github_1.context.issue && github_1.context.issue.number) {
        info = await octokit.graphql(`query($owner: String!, $name: String!, $prNumber: Int!) {
			repository(owner: $owner, name: $name) {
				pullRequest(number: $prNumber) {
					files(first: 100) {
						nodes {
							path
						}
					}
					commits(last: 1) {
						nodes {
							commit {
								oid
							}
						}
					}
				}
			}
		}`, {
            owner: github_1.context.repo.owner,
            name: github_1.context.repo.repo,
            prNumber: github_1.context.issue.number
        });
        currentSha = info.repository.pullRequest.commits.nodes[0].commit.oid;
        const files = info.repository.pullRequest.files.nodes;
        lintFiles = files.filter((file) => EXTENSIONS.has(path_1.extname(file.path)) && !file.path.includes('.d.ts')).map((f) => f.path);
    }
    else {
        info = await octokit.repos.getCommit({ owner: github_1.context.repo.owner, repo: github_1.context.repo.repo, ref: GITHUB_SHA });
        currentSha = GITHUB_SHA;
        const files = info.data.files;
        lintFiles = files.filter(file => EXTENSIONS.has(path_1.extname(file.filename)) && !file.filename.includes('.d.ts') && file.status !== 'removed' && file.status !== 'changed').map(f => f.filename);
    }
    core_1.debug(`Commit: ${currentSha}`);
    let id;
    const jobName = core_1.getInput('job-name');
    if (jobName) {
        const checks = await octokit.checks.listForRef({
            ...github_1.context.repo,
            status: 'in_progress',
            ref: currentSha
        });
        const check = checks.data.check_runs.find(({ name }) => name.toLowerCase() === jobName.toLowerCase());
        if (check)
            id = check.id;
    }
    if (!id) {
        id = (await octokit.checks.create({
            ...github_1.context.repo,
            name: ACTION_NAME,
            head_sha: currentSha,
            status: 'in_progress',
            started_at: new Date().toISOString()
        })).data.id;
    }
    try {
        const lintAll = core_1.getInput('lint-all');
        const { conclusion, output } = await lint(lintAll ? null : lintFiles);
        await octokit.checks.update({
            ...github_1.context.repo,
            check_run_id: id,
            completed_at: new Date().toISOString(),
            conclusion,
            output
        });
        core_1.debug(output.summary);
        if (conclusion === 'failure')
            core_1.setFailed(output.summary);
    }
    catch (error) {
        await octokit.checks.update({
            ...github_1.context.repo,
            check_run_id: id,
            conclusion: 'failure',
            completed_at: new Date().toISOString()
        });
        core_1.setFailed(error.message);
    }
}
run();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIvIiwic291cmNlcyI6WyJtYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQXFDO0FBRXJDLDRDQUFrRDtBQUNsRCx3Q0FBMkQ7QUFFM0QsTUFBTSxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO0FBRW5FLE1BQU0sV0FBVyxHQUFHLFFBQVEsQ0FBQztBQUM3QixNQUFNLFVBQVUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBRTNDLEtBQUssVUFBVSxJQUFJLENBQUMsS0FBc0I7SUFDekMsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLDJDQUFhLFdBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUscUJBQXFCLENBQUMsRUFBNEIsQ0FBQztJQUMxRyxNQUFNLEdBQUcsR0FBRyxJQUFJLFNBQVMsQ0FBQztRQUN6QixVQUFVLEVBQUUsQ0FBQyxHQUFHLFVBQVUsQ0FBQztRQUMzQixVQUFVLEVBQUUsWUFBWTtLQUN4QixDQUFDLENBQUM7SUFDSCxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsY0FBYyxDQUFDLEtBQUssSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDcEQsTUFBTSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLEdBQUcsTUFBTSxDQUFDO0lBQ3JELE1BQU0sTUFBTSxHQUE4RCxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDM0csTUFBTSxXQUFXLEdBQTBDLEVBQUUsQ0FBQztJQUM5RCxNQUFNLGFBQWEsR0FBYSxFQUFFLENBQUM7SUFDbkMsS0FBSyxNQUFNLEdBQUcsSUFBSSxPQUFPLEVBQUU7UUFDMUIsTUFBTSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsR0FBRyxHQUFHLENBQUM7UUFDbkMsTUFB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Q0FBQyxJQUFJO1lBQ2YsWUFBWSxFQUFFLEVBQUU7WUFDaEIsVUFBVSxFQUFFLFNBQVM7WUFDckIsWUFBWSxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1NBQ3RDLENBQUMsQ0FBQztRQUNILGdCQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQ3pCO0FBQ0YsQ0FBQztBQUVELEdBQUcsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgam9pbiwgZXh0bmFtZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgQ2hlY2tzVXBkYXRlUGFyYW1zT3V0cHV0QW5ub3RhdGlvbnMsIENoZWNrc0NyZWF0ZVBhcmFtcyB9IGZyb20gJ0BvY3Rva2l0L3Jlc3QnO1xuaW1wb3J0IHsgR2l0SHViLCBjb250ZXh0IH0gZnJvbSAnQGFjdGlvbnMvZ2l0aHViJztcbmltcG9ydCB7IGdldElucHV0LCBzZXRGYWlsZWQsIGRlYnVnIH0gZnJvbSAnQGFjdGlvbnMvY29yZSc7XG5cbmNvbnN0IHsgR0lUSFVCX1RPS0VOLCBHSVRIVUJfU0hBLCBHSVRIVUJfV09SS1NQQUNFIH0gPSBwcm9jZXNzLmVudjtcblxuY29uc3QgQUNUSU9OX05BTUUgPSAnRVNMaW50JztcbmNvbnN0IEVYVEVOU0lPTlMgPSBuZXcgU2V0KFsnLnRzJywgJy5qcyddKTtcblxuYXN5bmMgZnVuY3Rpb24gbGludChmaWxlczogc3RyaW5nW10gfCBudWxsKSB7XG5cdGNvbnN0IHsgQ0xJRW5naW5lIH0gPSBhd2FpdCBpbXBvcnQoam9pbihwcm9jZXNzLmN3ZCgpLCAnbm9kZV9tb2R1bGVzL2VzbGludCcpKSBhcyB0eXBlb2YgaW1wb3J0KCdlc2xpbnQnKTtcblx0Y29uc3QgY2xpID0gbmV3IENMSUVuZ2luZSh7XG5cdFx0ZXh0ZW5zaW9uczogWy4uLkVYVEVOU0lPTlNdLFxuXHRcdGlnbm9yZVBhdGg6ICcuZ2l0aWdub3JlJ1xuXHR9KTtcblx0Y29uc3QgcmVwb3J0ID0gY2xpLmV4ZWN1dGVPbkZpbGVzKGZpbGVzIHx8IFsnc3JjJ10pO1xuXHRjb25zdCB7IHJlc3VsdHMsIGVycm9yQ291bnQsIHdhcm5pbmdDb3VudCB9ID0gcmVwb3J0O1xuXHRjb25zdCBsZXZlbHM6IENoZWNrc1VwZGF0ZVBhcmFtc091dHB1dEFubm90YXRpb25zWydhbm5vdGF0aW9uX2xldmVsJ11bXSA9IFsnbm90aWNlJywgJ3dhcm5pbmcnLCAnZmFpbHVyZSddO1xuXHRjb25zdCBhbm5vdGF0aW9uczogQ2hlY2tzVXBkYXRlUGFyYW1zT3V0cHV0QW5ub3RhdGlvbnNbXSA9IFtdO1xuXHRjb25zdCBjb25zb2xlT3V0cHV0OiBzdHJpbmdbXSA9IFtdO1xuXHRmb3IgKGNvbnN0IHJlcyBvZiByZXN1bHRzKSB7XG5cdFx0Y29uc3QgeyBmaWxlUGF0aCwgbWVzc2FnZXMgfSA9IHJlcztcblx0XHRjb25zdCBwYXRoID0gZmlsZVBhdGguc3Vic3RyaW5nKEdJVEhVQl9XT1JLU1BBQ0UhLmxlbmd0aCArIDEpO1xuXHRcdGZvciAoY29uc3QgbXNnIG9mIG1lc3NhZ2VzKSB7XG5cdFx0XHRjb25zdCB7IGxpbmUsIGVuZExpbmUsIGNvbHVtbiwgZW5kQ29sdW1uLCBzZXZlcml0eSwgcnVsZUlkLCBtZXNzYWdlIH0gPSBtc2c7XG5cdFx0XHRjb25zdCBhbm5vdGF0aW9uTGV2ZWwgPSBsZXZlbHNbc2V2ZXJpdHldO1xuXHRcdFx0YW5ub3RhdGlvbnMucHVzaCh7XG5cdFx0XHRcdHBhdGgsXG5cdFx0XHRcdHN0YXJ0X2xpbmU6IGxpbmUsXG5cdFx0XHRcdGVuZF9saW5lOiBlbmRMaW5lIHx8IGxpbmUsXG5cdFx0XHRcdHN0YXJ0X2NvbHVtbjogY29sdW1uLFxuXHRcdFx0XHRlbmRfY29sdW1uOiBlbmRDb2x1bW4gfHwgY29sdW1uLFxuXHRcdFx0XHRhbm5vdGF0aW9uX2xldmVsOiBhbm5vdGF0aW9uTGV2ZWwsXG5cdFx0XHRcdHRpdGxlOiBydWxlSWQgfHwgQUNUSU9OX05BTUUsXG5cdFx0XHRcdG1lc3NhZ2U6IGAke21lc3NhZ2V9JHtydWxlSWQgPyBgXFxuXFxuaHR0cHM6Ly9lc2xpbnQub3JnL2RvY3MvcnVsZXMvJHtydWxlSWR9YCA6ICcnfWBcblx0XHRcdH0pO1xuXHRcdFx0Y29uc29sZU91dHB1dC5wdXNoKHBhdGgpO1xuXHRcdFx0Y29uc29sZU91dHB1dC5wdXNoKGAjI1ske3NldmVyaXR5fV0gICR7bGluZX06JHtjb2x1bW59ICAke3NldmVyaXR5fSAgJHttZXNzYWdlfSAgJHtydWxlSWR9XFxuXFxuYCk7XG5cdFx0fVxuXHR9XG5cdGNvbnNvbGUubG9nKGNvbnNvbGVPdXRwdXQuam9pbignJykpO1xuXG5cdHJldHVybiB7XG5cdFx0Y29uY2x1c2lvbjogZXJyb3JDb3VudCA+IDAgPyAnZmFpbHVyZScgOiAnc3VjY2VzcycgYXMgQ2hlY2tzQ3JlYXRlUGFyYW1zWydjb25jbHVzaW9uJ10sXG5cdFx0b3V0cHV0OiB7XG5cdFx0XHR0aXRsZTogQUNUSU9OX05BTUUsXG5cdFx0XHRzdW1tYXJ5OiBgJHtlcnJvckNvdW50fSBlcnJvcihzKSwgJHt3YXJuaW5nQ291bnR9IHdhcm5pbmcocykgZm91bmRgLFxuXHRcdFx0YW5ub3RhdGlvbnNcblx0XHR9XG5cdH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJ1bigpIHtcblx0Y29uc3Qgb2N0b2tpdCA9IG5ldyBHaXRIdWIoR0lUSFVCX1RPS0VOISk7XG5cblx0bGV0IGN1cnJlbnRTaGE6IHN0cmluZztcblx0bGV0IGluZm87XG5cdGxldCBsaW50RmlsZXM7XG5cdGlmIChjb250ZXh0Lmlzc3VlICYmIGNvbnRleHQuaXNzdWUubnVtYmVyKSB7XG5cdFx0aW5mbyA9IGF3YWl0IG9jdG9raXQuZ3JhcGhxbChgcXVlcnkoJG93bmVyOiBTdHJpbmchLCAkbmFtZTogU3RyaW5nISwgJHByTnVtYmVyOiBJbnQhKSB7XG5cdFx0XHRyZXBvc2l0b3J5KG93bmVyOiAkb3duZXIsIG5hbWU6ICRuYW1lKSB7XG5cdFx0XHRcdHB1bGxSZXF1ZXN0KG51bWJlcjogJHByTnVtYmVyKSB7XG5cdFx0XHRcdFx0ZmlsZXMoZmlyc3Q6IDEwMCkge1xuXHRcdFx0XHRcdFx0bm9kZXMge1xuXHRcdFx0XHRcdFx0XHRwYXRoXG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGNvbW1pdHMobGFzdDogMSkge1xuXHRcdFx0XHRcdFx0bm9kZXMge1xuXHRcdFx0XHRcdFx0XHRjb21taXQge1xuXHRcdFx0XHRcdFx0XHRcdG9pZFxuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fWAsXG5cdFx0e1xuXHRcdFx0b3duZXI6IGNvbnRleHQucmVwby5vd25lcixcblx0XHRcdG5hbWU6IGNvbnRleHQucmVwby5yZXBvLFxuXHRcdFx0cHJOdW1iZXI6IGNvbnRleHQuaXNzdWUubnVtYmVyXG5cdFx0fSk7XG5cdFx0Y3VycmVudFNoYSA9IGluZm8ucmVwb3NpdG9yeS5wdWxsUmVxdWVzdC5jb21taXRzLm5vZGVzWzBdLmNvbW1pdC5vaWQ7XG5cdFx0Y29uc3QgZmlsZXMgPSBpbmZvLnJlcG9zaXRvcnkucHVsbFJlcXVlc3QuZmlsZXMubm9kZXM7XG5cdFx0bGludEZpbGVzID0gZmlsZXMuZmlsdGVyKChmaWxlOiB7IHBhdGg6IHN0cmluZyB9KSA9PiBFWFRFTlNJT05TLmhhcyhleHRuYW1lKGZpbGUucGF0aCkpICYmICFmaWxlLnBhdGguaW5jbHVkZXMoJy5kLnRzJykpLm1hcCgoZjogeyBwYXRoOiBzdHJpbmcgfSkgPT4gZi5wYXRoKTtcblx0fSBlbHNlIHtcblx0XHRpbmZvID0gYXdhaXQgb2N0b2tpdC5yZXBvcy5nZXRDb21taXQoeyBvd25lcjogY29udGV4dC5yZXBvLm93bmVyLCByZXBvOiBjb250ZXh0LnJlcG8ucmVwbywgcmVmOiBHSVRIVUJfU0hBISB9KTtcblx0XHRjdXJyZW50U2hhID0gR0lUSFVCX1NIQSE7XG5cdFx0Y29uc3QgZmlsZXMgPSBpbmZvLmRhdGEuZmlsZXM7XG5cdFx0bGludEZpbGVzID0gZmlsZXMuZmlsdGVyKGZpbGUgPT4gRVhURU5TSU9OUy5oYXMoZXh0bmFtZShmaWxlLmZpbGVuYW1lKSkgJiYgIWZpbGUuZmlsZW5hbWUuaW5jbHVkZXMoJy5kLnRzJykgJiYgZmlsZS5zdGF0dXMgIT09ICdyZW1vdmVkJyAmJiBmaWxlLnN0YXR1cyAhPT0gJ2NoYW5nZWQnKS5tYXAoZiA9PiBmLmZpbGVuYW1lKTtcblx0fVxuXHRkZWJ1ZyhgQ29tbWl0OiAke2N1cnJlbnRTaGF9YCk7XG5cblx0bGV0IGlkOiBudW1iZXIgfCB1bmRlZmluZWQ7XG5cdGNvbnN0IGpvYk5hbWUgPSBnZXRJbnB1dCgnam9iLW5hbWUnKTtcblx0aWYgKGpvYk5hbWUpIHtcblx0XHRjb25zdCBjaGVja3MgPSBhd2FpdCBvY3Rva2l0LmNoZWNrcy5saXN0Rm9yUmVmKHtcblx0XHRcdC4uLmNvbnRleHQucmVwbyxcblx0XHRcdHN0YXR1czogJ2luX3Byb2dyZXNzJyxcblx0XHRcdHJlZjogY3VycmVudFNoYVxuXHRcdH0pO1xuXHRcdGNvbnN0IGNoZWNrID0gY2hlY2tzLmRhdGEuY2hlY2tfcnVucy5maW5kKCh7IG5hbWUgfSkgPT4gbmFtZS50b0xvd2VyQ2FzZSgpID09PSBqb2JOYW1lLnRvTG93ZXJDYXNlKCkpO1xuXHRcdGlmIChjaGVjaykgaWQgPSBjaGVjay5pZDtcblx0fVxuXHRpZiAoIWlkKSB7XG5cdFx0aWQgPSAoYXdhaXQgb2N0b2tpdC5jaGVja3MuY3JlYXRlKHtcblx0XHRcdC4uLmNvbnRleHQucmVwbyxcblx0XHRcdG5hbWU6IEFDVElPTl9OQU1FLFxuXHRcdFx0aGVhZF9zaGE6IGN1cnJlbnRTaGEsXG5cdFx0XHRzdGF0dXM6ICdpbl9wcm9ncmVzcycsXG5cdFx0XHRzdGFydGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcblx0XHR9KSkuZGF0YS5pZDtcblx0fVxuXG5cdHRyeSB7XG5cdFx0Y29uc3QgbGludEFsbCA9IGdldElucHV0KCdsaW50LWFsbCcpO1xuXHRcdGNvbnN0IHsgY29uY2x1c2lvbiwgb3V0cHV0IH0gPSBhd2FpdCBsaW50KGxpbnRBbGwgPyBudWxsIDogbGludEZpbGVzKTtcblx0XHRhd2FpdCBvY3Rva2l0LmNoZWNrcy51cGRhdGUoe1xuXHRcdFx0Li4uY29udGV4dC5yZXBvLFxuXHRcdFx0Y2hlY2tfcnVuX2lkOiBpZCxcblx0XHRcdGNvbXBsZXRlZF9hdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuXHRcdFx0Y29uY2x1c2lvbixcblx0XHRcdG91dHB1dFxuXHRcdH0pO1xuXHRcdGRlYnVnKG91dHB1dC5zdW1tYXJ5KTtcblx0XHRpZiAoY29uY2x1c2lvbiA9PT0gJ2ZhaWx1cmUnKSBzZXRGYWlsZWQob3V0cHV0LnN1bW1hcnkpO1xuXHR9IGNhdGNoIChlcnJvcikge1xuXHRcdGF3YWl0IG9jdG9raXQuY2hlY2tzLnVwZGF0ZSh7XG5cdFx0XHQuLi5jb250ZXh0LnJlcG8sXG5cdFx0XHRjaGVja19ydW5faWQ6IGlkLFxuXHRcdFx0Y29uY2x1c2lvbjogJ2ZhaWx1cmUnLFxuXHRcdFx0Y29tcGxldGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcblx0XHR9KTtcblx0XHRzZXRGYWlsZWQoZXJyb3IubWVzc2FnZSk7XG5cdH1cbn1cblxucnVuKCk7XG4iXX0=